#!/bin/bash
set -e

# Check if www-data user exists
if ! id -u www-data >/dev/null 2>&1; then
    echo "Warning: www-data user does not exist. Creating it..."
    useradd -r -s /usr/sbin/nologin www-data || true
fi

# Create task directory with proper ownership and permissions
if [ ! -d /var/vsTaskViewer ]; then
    mkdir -p /var/vsTaskViewer
    chown www-data:www-data /var/vsTaskViewer
    chmod 700 /var/vsTaskViewer
fi

# Create config directory if it doesn't exist
if [ ! -d /etc/vsTaskViewer ]; then
    mkdir -p /etc/vsTaskViewer
fi

# Ensure HTML directory exists and has correct permissions
if [ ! -d /etc/vsTaskViewer/html ]; then
    mkdir -p /etc/vsTaskViewer/html
    chmod 755 /etc/vsTaskViewer/html
fi

# Ensure HTML files are readable (they should be installed by package, but verify)
if [ -d /etc/vsTaskViewer/html ]; then
    chmod 644 /etc/vsTaskViewer/html/*.html 2>/dev/null || true
    # Ensure directory is readable
    chmod 755 /etc/vsTaskViewer/html
fi

# Copy example config to actual config if it doesn't exist
if [ ! -f /etc/vsTaskViewer/vsTaskViewer.toml ]; then
    cp /etc/vsTaskViewer/vsTaskViewer.toml.example /etc/vsTaskViewer/vsTaskViewer.toml
    chmod 600 /etc/vsTaskViewer/vsTaskViewer.toml
    echo "Created /etc/vsTaskViewer/vsTaskViewer.toml from example."
    echo "WARNING: Please edit /etc/vsTaskViewer/vsTaskViewer.toml and change the auth.secret!"
fi

# Reload systemd and enable service
if [ -d /run/systemd/system ]; then
    systemctl daemon-reload
    systemctl enable vsTaskViewer.service || true
fi

# DEBHELPER#
exit 0

